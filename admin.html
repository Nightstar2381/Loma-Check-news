<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Fake News Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Supabase SDK ‚úÖ -->
    <script src="https://unpkg.com/@supabase/supabase-js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .card { margin-bottom: 20px; }
        .btn-approve { background-color: #28a745; color: white; }
        .btn-reject { background-color: #dc3545; color: white; }
        .btn-logout { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center my-4">üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏•‡∏≠‡∏° (Admin)</h2>
        <button id="logoutBtn" class="btn btn-logout mb-3">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div class="row" id="newsContainer"></div>
    </div>

    <script>
        // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
        const supabaseUrl = "https://zfdecmvrvmdvwksvivwd.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener("DOMContentLoaded", async function () {
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô!");
                window.location.href = "login.html";
                return;
            }

            const { data: userData, error: userError } = await supabase
                .from("users")
                .select("role")
                .eq("email", user.email)
                .single();

            if (userError || userData.role !== "admin") {
                alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ!");
                window.location.href = "index.html";
                return;
            }

            loadPendingNews();
        });

        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        async function loadPendingNews() {
            const newsContainer = document.getElementById("newsContainer");
            newsContainer.innerHTML = "";
            
            const { data, error } = await supabase.from("pending_news").select("*").order("created_at", { ascending: false });
            if (error) {
                console.error("‚ùå Error fetching news:", error);
                return;
            }
            
            data.forEach(news => {
                newsContainer.innerHTML += `
                    <div class="col-md-4">
                        <div class="card">
                            <img src="${news.imageUrl}" class="card-img-top" alt="News Image">
                            <div class="card-body">
                                <h5 class="card-title">${news.title}</h5>
                                <p class="card-text">${news.description.substring(0, 100)}...</p>
                                <a href="${news.url}" class="btn btn-info" target="_blank">üîó ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>
                                <button class="btn btn-approve" onclick="approveNews('${news.id}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-reject" onclick="deleteNews('${news.id}')">‚ùå ‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß
        async function approveNews(newsId) {
            const { data, error } = await supabase.from("pending_news").select("*").eq("id", newsId).single();
            if (error) {
                console.error("‚ùå Error approving news:", error);
                return;
            }

            const { error: insertError } = await supabase.from("verified_news").insert([{ ...data, approved: true }]);
            if (insertError) {
                console.error("‚ùå Error inserting into verified_news:", insertError);
                return;
            }

            await supabase.from("pending_news").delete().eq("id", newsId);
            alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            loadPendingNews();
        }

        // ‚úÖ ‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß
        async function deleteNews(newsId) {
            if (confirm("‚ùó ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ?")) {
                const { error } = await supabase.from("pending_news").delete().eq("id", newsId);
                if (error) {
                    console.error("‚ùå Error deleting news:", error);
                    return;
                }
                alert("üóë ‡∏Ç‡πà‡∏≤‡∏ß‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                loadPendingNews();
            }
        }

        // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await supabase.auth.signOut();
            alert("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            window.location.href = "login.html";
        });
    </script>
</body>
</html>
