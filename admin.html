<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Fake News Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .card { margin-bottom: 20px; }
        .btn-approve { background-color: #28a745; color: white; }
        .btn-reject { background-color: #dc3545; color: white; }
        .btn-logout { background-color: #6c757d; color: white; }
        .loading { text-align: center; font-size: 18px; color: #555; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center my-4">üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏•‡∏≠‡∏° (Admin)</h2>
        <button id="logoutBtn" class="btn btn-logout mb-3">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div id="loadingMessage" class="loading">‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...</div>
        <div class="row" id="newsContainer"></div>
    </div>

    <script>
        // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
        const supabaseUrl = "https://zfdecmvrvmdvwksvivwd.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmZGVjbXZydm1kdndrc3ZpdndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3MjAwMDQsImV4cCI6MjA1NzI5NjAwNH0.bDzI0gWKFF_lQRbjL5WOYIG0h1fFBQF8MxMPXWH_rEg"; // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Key ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener("DOMContentLoaded", async function () {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error || !user) {
                    alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô!");
                    window.location.href = "login.html";
                    return;
                }

                const { data: userData, error: userError } = await supabase
                    .from("users")
                    .select("role")
                    .eq("email", user.email)
                    .single();

                if (userError || userData.role !== "admin") {
                    alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ!");
                    window.location.href = "index.html";
                    return;
                }

                loadPendingNews();
            } catch (err) {
                console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:", err);
            }
        });

        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        async function loadPendingNews() {
            const newsContainer = document.getElementById("newsContainer");
            const loadingMessage = document.getElementById("loadingMessage");

            loadingMessage.style.display = "block";
            newsContainer.innerHTML = "";

            const { data, error } = await supabase
                .from("pending_news")
                .select("*")
                .order("created_at", { ascending: false });

            loadingMessage.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô Loading ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à

            if (error) {
                console.error("‚ùå Error fetching news:", error);
                newsContainer.innerHTML = `<p class="text-center text-danger">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ</p>`;
                return;
            }

            if (data.length === 0) {
                newsContainer.innerHTML = `<p class="text-center text-muted">üü° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>`;
                return;
            }

            data.forEach(news => {
                newsContainer.innerHTML += `
                    <div class="col-md-4">
                        <div class="card">
                            <img src="${news.imageUrl}" class="card-img-top" alt="News Image">
                            <div class="card-body">
                                <h5 class="card-title">${news.title}</h5>
                                <p class="card-text">${news.description.substring(0, 100)}...</p>
                                <a href="${news.url}" class="btn btn-info" target="_blank">üîó ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>
                                <button class="btn btn-approve" onclick="approveNews('${news.id}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-reject" onclick="deleteNews('${news.id}')">‚ùå ‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß
        async function approveNews(newsId) {
            try {
                const { data, error } = await supabase.from("pending_news").select("*").eq("id", newsId).single();
                if (error) throw error;

                const { error: insertError } = await supabase.from("verified_news").insert([{ ...data, approved: true }]);
                if (insertError) throw insertError;

                await supabase.from("pending_news").delete().eq("id", newsId);
                alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                loadPendingNews();
            } catch (err) {
                console.error("‚ùå Error approving news:", err);
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ");
            }
        }

        // ‚úÖ ‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß
        async function deleteNews(newsId) {
            if (confirm("‚ùó ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ?")) {
                try {
                    const { error } = await supabase.from("pending_news").delete().eq("id", newsId);
                    if (error) throw error;
                    alert("üóë ‡∏Ç‡πà‡∏≤‡∏ß‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                    loadPendingNews();
                } catch (err) {
                    console.error("‚ùå Error deleting news:", err);
                    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ");
                }
            }
        }

        // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                alert("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                window.location.href = "login.html";
            } catch (err) {
                console.error("‚ùå Error logging out:", err);
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ");
            }
        });
    </script>
</body>
</html>
